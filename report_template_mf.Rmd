---
title: "Mediation Analysis Report - Multiple Mediators at Fixed Time"
output: word_document
params:
  exposure: NULL
  mediators: NULL
  outcome: NULL
  basec_vars: NULL
  postc_vars: NULL
  yreg_type: NULL
  model_summary: NULL
  path_table: NULL
  dag_path: NULL
  path_plot_path: NULL
  proportion_mediated: NULL
  interpretation_text: NULL
  mreg_type: NULL
  postcreg_type: NULL
  interaction: NULL
  missing_data_method: NULL
  all_models: NULL
---

```{r, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(knitr)
# Helper to format lists with commas and "and"
fmt_list <- function(x) {
  x <- as.character(x)
  n <- length(x)
  if (n == 0) return("")
  if (n == 1) return(x)
  if (n == 2) return(paste(x, collapse = " and "))
  paste(paste(x[1:(n-1)], collapse = ", "), "and", x[n])
}
```


# 1. Objective
This analysis aimed to evaluate the extent to which the effect of `r params$exposure` on `r params$outcome` is mediated through `r fmt_list(params$mediators)`. We estimated path-specific effects—including direct, indirect, and total effects—for each mediator individually and for all mediators jointly using a counterfactual-based causal mediation framework, to disentangle how each mediator and their combined effect contribute to the total effect.

# 2. Methods
```{r, results = 'asis'}
pm_formula <- if (tolower(params$yreg_type) == "linear") {
  "the indirect effect divided by the total effect, multiplied by 100%"
} else if (tolower(params$yreg_type) == "logistic") {
  "(Direct × (Indirect − 1)) divided by (Total effect − 1)"
} else {
  "defined according to the chosen outcome model"
}

basec_sentence <- if (!is.null(params$basec_vars) && length(params$basec_vars) > 0) {
  sprintf("Baseline covariates %s were adjusted for.", fmt_list(params$basec_vars))
} else { "" }

postc_sentence <- if (!is.null(params$postc_vars) && length(params$postc_vars) > 0) {
  sprintf("Post-treatment confounders %s were controlled for.", fmt_list(params$postc_vars))
} else { "" }

marginal_joint_sentence <- sprintf(
  "Mediators investigated were %s; marginal models were fit for each mediator individually, and a joint model was fit including all mediators simultaneously to estimate the combined mediated effect.",
  fmt_list(params$mediators)
)

parts <- c(
  sprintf("Mediation analyses were conducted to decompose the total effect of %s on %s into direct effect and indirect effect.", params$exposure, params$outcome),
  sprintf("The direct effect quantified the effect of %s on change in %s independent of changes in the mediators.", params$exposure, params$outcome),
  sprintf("Conversely, the indirect effect captured the effect of %s on change in %s associated with changes in the mediators.", params$exposure, params$outcome),
  "Because these comparisons involve non-observable counterfactual scenarios, natural effect models were employed to estimate the direct and indirect effects.",
  "The total effect was defined as the sum of these two components.",
  sprintf("The proportion mediated was calculated as %s, and standard errors were derived using the bootstrap method.", pm_formula),
  sprintf("The outcome was %s.", params$outcome),
  if (nzchar(basec_sentence)) basec_sentence else NULL,
  marginal_joint_sentence,
  if (nzchar(postc_sentence)) postc_sentence else NULL
)

cat(paste(parts, collapse = " "))

```


# 3. Results by Model
```{r, results='asis'}
for (model_name in names(params$all_models)) {
  model <- params$all_models[[model_name]]

  # Title
  title <- if (model$is_joint) {
    paste0("### Joint Model: ", paste(params$mediators, collapse = ", "))
  } else {
    paste0("### Mediator: ", model$mediator)
  }
  cat(title, "\n\n")

  # 4.1 Path Effect Table
  cat("**3.1 Estimated Path Effects**\n\n")
  print(knitr::kable(model$table, digits = 3))
  cat("\n\n")

  # 4.2 DAG Diagram
  cat("**3.2 DAG Diagram**\n\n")
  cat("![](", model$dag_path, ")\n\n", sep = "")

  # 4.3 Forest Plot of Effects
  cat("**3.3 Forest Plot of Effects**\n\n")
  cat("![](", model$path_plot_path, ")\n\n", sep = "")

  # 4.4 Interpretation
  cat("**3.4 Interpretation**\n\n")
  cat(as.character(model$interpretation_text), "\n\n")

  cat("\n\n---------------------------------------------\n\n")
}

```























